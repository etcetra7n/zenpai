let firebase=require("firebase/app"),firestore=require("firebase/firestore"),Groq=require("groq-sdk"),firebaseConfig={apiKey:"AIzaSyCQEh9RtXWiQtY0Y2nTkDPuxbYEJhKTkW8",authDomain:"zenpai.firebaseapp.com",projectId:"zenpai",storageBucket:"zenpai.appspot.com",messagingSenderId:"393234421305",appId:"1:393234421305:web:cfa99cb18f11218043dfe8",measurementId:"G-FH52BJJ207"},app=firebase.initializeApp(firebaseConfig);async function logInstruction(e,t,r){try{var a=firestore.getFirestore(app);await firestore.addDoc(firestore.collection(a,"instruct_log"),{instruction:e,fileNum:t,result:r,timestamp:firestore.serverTimestamp()})}catch(e){throw e}}async function generateScript(e,t){var r,a=new Groq;let i="",n=(i=1==t?`You are given a txt file, write a python function called 'operation' which takes the file path as argument and "${e}". Save the result in a new file. Don't include any other details`:`You are given a list of files, write a python function called 'operation' which takes the list of file path as argument and "${e}". Save the result in new files. Don't include any other details`,"");for await(r of await a.chat.completions.create({messages:[{role:"system",content:"You are good in converting instructions into python scripts"},{role:"user",content:i}],model:"llama3-70b-8192",temperature:1,max_tokens:3024,top_p:1,stream:!0,stop:null}))n+=r.choices[0]?.delta?.content||"";return n}exports.handler=async(e,t)=>{if("POST"!==e.httpMethod)return{statusCode:405,body:"Method Not Allowed"};e=JSON.parse(e.body);if(plan=getUserPlan(e.uid),requests_last_hour=getLastHourRequests(e.uid),"free"==plan){if(50<e.file_num)return{statusCode:403,body:JSON.stringify({message:"Free plan users cannot run on more than 50 files. Upgrade to Versatile or Effective plan for more"})}}else if("versatile"==plan&&360<e.file_num)return{statusCode:403,body:JSON.stringify({message:"Versatile plan users cannot run on more than 360 files. Upgrade to Effective plan for more"})};let r=(await generateScript(e.instruction,e.file_num)).split("```")[1];return(r.startsWith("python")||r.startsWith("Python"))&&(r=r.substring(7)),await logInstruction(e.instruction,e.file_num,r),{statusCode:200,body:JSON.stringify({py_script:r})}};