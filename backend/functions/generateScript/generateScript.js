let admin=require("firebase-admin"),Groq=require("groq-sdk"),serviceAccount=require("../firebase-admin-serviceAccountKey.json"),db=(admin.apps.length||admin.initializeApp({credential:admin.credential.cert(serviceAccount)}),admin.firestore());async function getUserPlan(e){try{db.collection("users").doc(e).get().then(e=>{e=e.get("plan");return console.log("plan= "+e),e})}catch(e){throw e}}async function getLastHourRequests(e){try{var t=new Date;t.setHours(t.getHours()-1),db.collection("instruct_log").where("uid","==",e).where("timestamp",">",t).get().then(e=>{e=e.size;return console.log("count= "+e),e})}catch(e){throw e}}function logInstruction(e,t,n,r){try{db.collection("instruct_log").add({instruction:e,uid:t,file_num:n,result:r,timestamp:admin.firestore.FieldValue.serverTimestamp()})}catch(e){throw e}}async function generateScript(e,t){var n,r=new Groq;let o="",a=(o=1==t?`You are given a txt file, write a python function called 'operation' which takes the file path as argument and "${e}". Save the result in a new file. Don't include any other details`:`You are given a list of files, write a python function called 'operation' which takes the list of file path as argument and "${e}". Save the result in new files. Don't include any other details`,"");for await(n of await r.chat.completions.create({messages:[{role:"system",content:"You are good in converting instructions into python scripts"},{role:"user",content:o}],model:"llama3-70b-8192",temperature:1,max_tokens:3024,top_p:1,stream:!0,stop:null}))a+=n.choices[0]?.delta?.content||"";return a}exports.handler=async(e,t)=>{if("POST"!==e.httpMethod)return{statusCode:405,body:"Method Not Allowed"};var e=JSON.parse(e.body),n=(await getUserPlan(e.uid).then(async e=>{console.log("from then: "+await e)}),await getLastHourRequests(e.uid));if(console.log(await n),"free"==plan){if(50<e.file_num)return{statusCode:403,body:JSON.stringify({message:"Free plan users cannot run on more than 50 files. Upgrade to Versatile or Effective plan for more"})};if(30<n)return{statusCode:429,body:JSON.stringify({message:"Free plan users cannot run on more than 30 runs per hour. Upgrade to Versatile or Effective plan for more"})}}else if("versatile"==plan){if(360<e.file_num)return{statusCode:403,body:JSON.stringify({message:"Versatile plan users cannot run on more than 360 files. Upgrade to Effective plan for unlimited files"})};if(360<n)return{statusCode:429,body:JSON.stringify({message:"Versatile plan users cannot run on more than 360 runs per hour. Upgrade to Effective plan for more"})}}else if("effective"==plan&&5e5<n)return{statusCode:429,body:JSON.stringify({message:"Effective plan users cannot run on more than 500,000 runs per hour. Request for more runs at contact@zenpai.pro"})};let r=(await generateScript(e.instruction,e.file_num)).split("```")[1];return(r.startsWith("python")||r.startsWith("Python"))&&(r=r.substring(7)),logInstruction(e.instruction,e.uid,e.file_num,r),{statusCode:200,body:JSON.stringify({py_script:r})}};